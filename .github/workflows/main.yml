name: CI

on: push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Greeting
        run: echo "Hello, world!"

      - name: Another greeting
        run: echo "Hello, world!"
   
  log-variable:
    runs-on: ubuntu-latest
    
    steps:
    
      - uses: actions/checkout@v2
      
      - name: Set variable
        id: set-variable
        run: |
          if [ -f "index.json" ] 
            then
              full_report=""
              limit=3
              failures=`cat index.json | jq ".stats.failures"`
              jq -c '.results[].suites[]' index.json | while read -r i && [[ "$limit" != 0 ]]; do
                ((limit--))
                title=$(echo "$i" | jq '.tests[].title')
                file=$(echo "$i" | jq '.fullFile')
                message=$(echo "$i" | jq '.tests[].err.message')
                report=$(echo "ðŸ§ª TEST: $title \nðŸ“‚ FILE: $file \nðŸ”´ MESSAGE: $message \n")
                full_report+="$report \n"
                if [[ $limit == 0 ]]; then
                    full_report+="...showing 3 of ${failures} test fails"
                fi
                echo "::set-output name=fail_report::"${full_report}""
              done
            else
              echo "No failed"
          fi
        
      
      - name: Log variable
        id: log-variable
        run: |
          full_report=$(cat << EOF
            ${{ steps.set-variable.outputs.fail_report }}
          EOF
          )

          full_report=${full_report//$'\n'/'%0A'}

          echo "slack hook"
          echo "${{ secrets.SLACK_WEBHOOK_URL }}"
          echo -e "$full_report"
          
      - name: Slack notif
        uses: 8398a7/action-slack@v3
      
        with:
          status: custom
          fields: workflow,job,commit,repo,ref,author,took
          custom_payload: |
            {
              attachments: [{
                color: '${{ job.status }}' === 'success' ? 'good' : '${{ job.status }}' === 'failure' ? 'danger' : 'warning',
                text: `${process.env.AS_WORKFLOW}\n${process.env.AS_JOB} (${process.env.AS_COMMIT}) of ${process.env.AS_REPO}@${process.env.AS_REF} by ${process.env.AS_AUTHOR} ${{ job.status }} in ${process.env.AS_TOOK}`,
              }]`
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always() # Pick up events even if the job fails or is canceled.
