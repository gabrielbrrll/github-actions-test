name: CI

on: push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Greeting
        run: echo "Hello, world!"

      - name: Another greeting
        run: echo "Hello, world!"
  set-variable:
    runs-on: ubuntu-latest
    outputs:
      bar: ${{ steps.set-variables.outputs.foo }}
      failures: ${{ steps.set-variables.outputs.failures_count }}
      report: ${{ steps.set-variables.outputs.fail_report }}
    
    steps:
      - uses: actions/checkout@v2
    
      - name: Set variables
        id: set-variables
        run: |
          if [ -f "index.json" ] 
            then
              jq -c '.results[].suites[]' index.json | while read i; do
                  title=$(echo "$i" | jq '.tests[].title')
                  file=$(echo "$i" | jq '.fullFile')
                  message=$(echo "$i" | jq '.tests[].err.message')
                  report=$(echo "ðŸ§ª TEST: $title | ðŸ“‚ FILE: $file | ðŸ”´ MESSAGE: $message")
                  echo "::set-output name=fail_report::"${report}""
              done

              failures=`cat index.json | jq ".stats.failures"`

              echo "::set-output name=failures_count::"${failures}""
            else
              echo "No failed"
          fi
        
  log_variable:
    needs:
      - set-variable
    runs-on: ubuntu-latest
    
    steps:
    
      - uses: actions/checkout@v2
      
      - name: Log variable
        id: log-variable
        run: |
          echo "${{ needs.set-variable.outputs.failures }}"
          echo `${{ needs.set-variable.outputs.report }}`
        
    
    
      

